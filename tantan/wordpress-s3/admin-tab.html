<?php
function print_keys($keys, $level=0) {
    echo "<ul class='level-$level'>\n";
    foreach ($keys as $key => $obj) if ($key{0} != '_') {
        echo '<li class="level-'.$level.'"><div class="prefix">'.$key."</div>\n";
        
        print_keys($obj, $level+1);
        echo "</li>\n";
    }
    
    if (is_array($keys['_objects'])) foreach ($keys['_objects'] as $obj) {
        echo '<li class="level-'.$level.'"><a href="'.$keys['_path'].$obj.'">'.$obj."</a></li>\n";
    }
    echo "</ul>\n";
    
}

?>

<div id="amazon-s3-wrap">

<div class="infobar">

<span class="nav-controls">
<?php if (true || $_SERVER['HTTP_REFERER']):?>
<a href="javascript:history.back()" onclick="" id="btn-back" title="back">back</a>
<a href="javascript:history.forward()" onclick="" id="btn-forward" title="forward">forward</a>
<?php endif; ?>
<a href="javascript:window.location.reload()" onclick="" id="btn-refresh" title="refresh view">refresh</a>
</span>
<span class="path">
<?php 
$tree = $keys;
echo '<a href="'.add_query_arg('prefix', urlencode(''), $_SERVER['REQUEST_URI']).'" class="home">home</a> / ';
$path = '/';
$paths = preg_split('/\//', $prefix, 100, PREG_SPLIT_NO_EMPTY);
$numPaths = count($paths);
$i=0;
foreach ($paths as $name) if ($name) {
    $path .= $name .'/';
    $isLast = (++$i) >= $numPaths;
    echo '<a class="'.( $isLast ? 'last' : '').'" href="'.add_query_arg('prefix', urlencode($path), $_SERVER['REQUEST_URI']).'">'.$name.'</a> '.(!$isLast ? ' / ' : ' ');
}
?>
</span>
<span class="options">
<form>
<input type="checkbox" name="useBittorrent" id="useBittorrent" value="1" /><label for="useBittorrent"> create links as torrents</label>
</form>
</span>
</div>
<div class="folders">
<ul id="prefixes">
<?php 
if (is_array($prefixes)) foreach ($prefixes as $prefix):
$label = substr($prefix, strrpos(trim($prefix, '/'), '/')+1);
$label = ereg_replace($path, "", '/'.$prefix);
$label = trim($prefix, '/');
if (ereg('/', $label)) $label = substr($label, strrpos($label, '/')+1);
?>
<li><a href="<?php echo add_query_arg('prefix', urlencode($prefix), $_SERVER['REQUEST_URI']);?>"><?php echo $label;?></a></li>
<?php 
endforeach;
?>
</ul>
</div>
<div class="files">
<ul id="keys">
<?php if (is_array($keys)) foreach ($keys as $i => $file): 
    $file = '/'.$file;
    $url = 'http://'.$accessDomain.$file;
    $label = substr($file, strrpos($file, '/')+1);
?>
<li><a 
<?php if (ereg("^image/.*", $meta[$i]['content-type'])):?>
onclick="return s3_insertImage('<?php echo $url;?>')"
<?php else:?>
onclick="return s3_insertLink('<?php echo addslashes($label);?>', '<?php echo $url;?>')"
<?php endif;?>
href="<?php echo $url;?>" 
class="file <?php echo ereg_replace('/', ' ', $meta[$i]['content-type']);?>" 
title="<?php echo $meta[$i]['date'];?> - <?php echo $meta[$i]['content-length'];?> bytes"><?php echo $label;?></a>
</li>
<?php endforeach;?>
</ul>
</div>
</div>
<br clear="both" />